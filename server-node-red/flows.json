[{"id":"64bf31f7.39303","type":"tab","label":"Counter in","disabled":false,"info":""},{"id":"8aef53de.c9aa78","type":"tab","label":"Database","disabled":false,"info":""},{"id":"4d72abac.9f6a5c","type":"tab","label":"Skylab Dashboard","disabled":false,"info":""},{"id":"22a24c0b.79fce4","type":"tab","label":"Skylab mantainenence","disabled":false,"info":""},{"id":"1e694d7d.101bf3","type":"tab","label":"ITU dashboard","disabled":false,"info":""},{"id":"5d4f9edd.b92f48","type":"tab","label":"Debugger & Heartbeat","disabled":false,"info":""},{"id":"daeabae8.5efdd","type":"tab","label":"System","disabled":false,"info":""},{"id":"fd1ac5b9.8d104","type":"subflow","name":"database","info":"","category":"","in":[{"x":20,"y":80,"wires":[{"id":"405f74d9.a8f624"}]}],"out":[{"x":360,"y":80,"wires":[{"id":"405f74d9.a8f624","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"959d9516.ea717","type":"sqlitedb","z":"","db":"/data/database.db","mode":"RWC"},{"id":"512f506d.1c2c8","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","reset":false},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":true},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":true},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":true},"group-backgroundColor":{"value":"#ffffff","edited":true},"widget-textColor":{"value":"#111111","edited":true},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":true},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Skylab Entry Counter","hideToolbar":"true","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"d796e2d5.12f988","type":"ui_tab","z":"","name":"Debugger","icon":"dashboard","disabled":false,"hidden":false},{"id":"7ad48c00.72c1e4","type":"ui_group","z":"","name":"Default","tab":"1c92ff6c.9201c9","order":5,"disp":false,"width":"24","collapse":false},{"id":"1c92ff6c.9201c9","type":"ui_tab","z":"","name":"Skylab Dashboard","icon":"dashboard","disabled":false,"hidden":false},{"id":"bb0a3cfd.cde0f","type":"ui_group","z":"","name":"Default","tab":"d796e2d5.12f988","order":1,"disp":false,"width":"6","collapse":false},{"id":"e660847b.65f71","type":"ui_group","z":"","name":"Table","tab":"","order":1,"disp":true,"width":"14","collapse":false},{"id":"ca1736d1.95c78","type":"ui_group","z":"","name":"Two dimension Array","tab":"","order":2,"disp":true,"width":"6","collapse":false},{"id":"af0095a8.08fb7","type":"ui_group","name":"Crew","tab":"","order":1,"disp":true,"width":"6","collapse":false},{"id":"81e28f95.636ad8","type":"telegram bot","z":"","botname":"Iot-lab","usernames":"","chatids":"","baseapiurl":"","updatemode":"polling","pollinterval":"5000","usesocks":false,"sockshost":"","socksport":"","socksusername":"","sockspassword":"","bothost":"","botpath":"","localbotport":"","publicbotport":"","privatekey":"","certificate":"","useselfsignedcertificate":false,"sslterminated":false,"verboselogging":false},{"id":"e89f79b5.38dc18","type":"http in","z":"64bf31f7.39303","name":"","url":"/count","method":"post","upload":false,"swaggerDoc":"","x":190,"y":160,"wires":[["73f9b90.5e43e48","547fe9f7.946f9"]]},{"id":"73f9b90.5e43e48","type":"http response","z":"64bf31f7.39303","name":"","statusCode":"","headers":{},"x":370,"y":60,"wires":[]},{"id":"547fe9f7.946f9","type":"function","z":"64bf31f7.39303","name":"Parse input","func":"const msgOut = {\n    \"door\": \"\\'\" + msg.payload.channel_name + \"\\'\",\n    \"time\": new Date(msg.payload.event_time).getTime(),\n    ...(msg.payload.rule_name == \"Enter\" && {\"direction_in\": 1}),\n    ...(msg.payload.rule_name == \"Exit\" && {\"direction_out\": 1})\n};\n\nmsg.payload = msgOut;\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":160,"wires":[["2970dd42.da8692","4d9723cb.6673cc","4f3851cb.9c8de"]]},{"id":"da86c9ef.f2c268","type":"function","z":"64bf31f7.39303","name":"Sample","func":"msg.payload = {\"channel_id\":\"5d4715c8-56b3-4e25-a56c-706f05611004\",\"channel_name\":\"Elevator\",\"event_name\":\"Crossed line\",\"event_origin\":\"Pedestrian\",\"event_time\":\"2020-12-30T16:15:08.6991366+01:00\",\"event_type\":\"TripwireCrossed\",\"object_id\":1,\"rule_id\":\"08dc4a0e-825e-44e6-a5e4-1bc029bf41e2\",\"rule_name\":\"Enter\"}\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":360,"wires":[[]]},{"id":"cdd7c8d4.f1b18","type":"inject","z":"64bf31f7.39303","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":360,"wires":[["da86c9ef.f2c268"]]},{"id":"7a21c2a8.0a5bc4","type":"inject","z":"8aef53de.c9aa78","name":"create counterTable","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":270,"y":320,"wires":[["be7f757c.395d3"]]},{"id":"be7f757c.395d3","type":"function","z":"8aef53de.c9aa78","name":"create counterTable","func":"msg.topic = \"CREATE TABLE counterTable (time INTEGER PRIMARY KEY, door TEXT NOT NULL, direction_in INTEGER DEFAULT 0, direction_out INTEGER DEFAULT 0)\"\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":320,"wires":[[]]},{"id":"2970dd42.da8692","type":"link out","z":"64bf31f7.39303","name":"to database","links":["18940b42.68d475"],"x":795,"y":120,"wires":[]},{"id":"1f0719e6.29d3c6","type":"function","z":"8aef53de.c9aa78","name":"clear counterTable","func":"msg.topic = \"DELETE FROM counterTable where door = 'Elevator'\"\n\nreturn msg;","outputs":1,"noerr":0,"x":515,"y":512,"wires":[[]]},{"id":"7a800aad.967694","type":"inject","z":"8aef53de.c9aa78","name":"clear counterTable","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":275,"y":512,"wires":[["1f0719e6.29d3c6"]]},{"id":"b0fe9f25.622c58","type":"function","z":"64bf31f7.39303","name":"Parsed sample","func":"var direction = Math.round(Math.random());\n\nout = {\"door\":\"'Elevator'\",\"time\":msg.payload}\n\nif (direction) {out.direction_in = 1}\nif (!direction) {out.direction_out = 1}\n\nmsg.payload = out;\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":440,"wires":[[]]},{"id":"d77a0a32.45d27","type":"inject","z":"64bf31f7.39303","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":440,"wires":[["b0fe9f25.622c58"]]},{"id":"4efdeaa3.be1c54","type":"comment","z":"64bf31f7.39303","name":"To database","info":"","x":850,"y":80,"wires":[]},{"id":"6b54cc1.0a23c34","type":"link out","z":"64bf31f7.39303","name":"to dashboard","links":["ebedea17.4f8138"],"x":935,"y":200,"wires":[]},{"id":"a8d92e27.5f9fb","type":"comment","z":"64bf31f7.39303","name":"To skylab dashboard","info":"","x":870,"y":240,"wires":[]},{"id":"ebedea17.4f8138","type":"link in","z":"4d72abac.9f6a5c","name":"","links":["6b54cc1.0a23c34"],"x":155,"y":100,"wires":[["c53d722b.e84fb"]]},{"id":"405f74d9.a8f624","type":"sqlite","z":"fd1ac5b9.8d104","mydb":"959d9516.ea717","sqlquery":"msg.topic","sql":"","name":"","x":190,"y":80,"wires":[[]]},{"id":"5dd8f2c2.75403c","type":"ui_template","z":"4d72abac.9f6a5c","group":"","name":"Dashboard stylesheet","order":1,"width":0,"height":0,"format":"<style>\n    :root {\n        --main-color: RGB(252, 118, 52);\n    }\n    \n    h1 {\n        font-size: 48px!important;\n    }\n    \n    .nr-dashboard-theme ui-card-panel {\n        border: 0px!important;\n    }\n    \n    \n    body.nr-dashboard-theme {\n      /* font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen-Sans, Ubuntu, Cantarell, Helvetica Neue, sans-serif; */\n      font-family: Roboto, Helvetica Neue, sans-serif;\n    }\n    \n    .ng-scope md-card{\n        width: 98vw!important;\n        height:98vh!important;\n    }\n    \n    .nr-dashboard-cardcontainer {\n        width:98vw!important;\n        height:98vh!important;\n    }\n\n    \n    .nr-dashboard-template h2 {\n        color: var(--main-color)!important;\n        font-weight: bold!important;\n        font-size: 48px!important;\n        background-color: transparent!important;\n        margin: 0;\n    }\n    \n    .nr-dashboard-template h3 {\n        color: Gray!important;\n        font-size: 24px!important;\n        background-color: transparent!important;\n        margin: 0;\n        font-weight:lighter;\n    }\n    \n    .feather {\n        width: 100px;\n        height: 100px;\n        color: var(--main-color)!important;\n    }\n    \n    .nr-dashboard-theme .nr-dashboard-template path {\n        fill: none;\n    }\n    \n    .interval-icon {\n        width: 50px;\n        height: 50px;\n    }\n    \n    .interval-time {\n        color: var(--main-color)!important;\n    }\n    \n    .interval-count {\n        color: var(--main-color)!important;\n        font-size:24px;\n        font-weight: bold;\n    }\n    \n    .interval-visitors {\n        color: Gray!important;\n        font-weight: lighter;\n    }\n\n    .border-top {\n        border-top: 5px dashed var(--main-color);\n    }\n    .border-top-solid {\n        border-top: 5px solid var(--main-color);\n    }\n\n    \n    .sideLines {\n        background-color: var(--main-color);\n        min-height: 200px;\n        color: white;\n        font-weight: bold;\n        font-size: 30px!important;\n        writing-mode: vertical-rl;\n        text-transform: uppercase;\n        display: flex!important;\n            line-height: 1.7em;\n    }\n    \n    .counter-item {\n    display: grid;\n    justify-content: center!important;\n    align-content: center!important;\n    text-align: center!important;\n    }\n\n.grid-container {\n    height: 90vh!important;\n  display: grid;\n  grid-template-columns: 50px 1fr 50px;\n  grid-template-rows: 2fr 1fr 1fr 1fr;\n  gap: 0px 0px;\n  grid-template-areas:\n    \"todaySep todayContent todaySide\"\n    \"weekSide weekContent weekSep\"\n    \"monthSep monthContent monthSide\"\n    \"yearSide yearContent yearSep\";\n}\n\n.todaySep { grid-area: todaySep; }\n\n.todayContent {\n  display: grid;\n  grid-template-columns: 1fr 1fr;\n  grid-template-rows: 1fr 1fr;\n  gap: 0px 0px;\n  grid-template-areas:\n    \"firstVisitor currentVisitor\"\n    \"intervals todayVisitors\";\n  grid-area: todayContent;\n}\n\n.firstVisitor { grid-area: firstVisitor; }\n\n.currentVisitor { grid-area: currentVisitor; }\n\n.intervals { grid-area: intervals; }\n\n.todayVisitors { grid-area: todayVisitors; }\n\n.todaySide { grid-area: todaySide; }\n\n.weekSep { grid-area: weekSep; }\n\n.weekContent { grid-area: weekContent; }\n\n.weekSide { grid-area: weekSide; }\n\n.monthSep { grid-area: monthSep; }\n\n.monthContent { grid-area: monthContent; }\n\n.monthSide { grid-area: monthSide; }\n\n.yearSep { grid-area: yearSep; }\n\n.yearContent {\n  /* display: grid;\n  grid-template-columns: 1fr 1fr;\n  grid-template-rows: 1fr;\n  gap: 0px 0px;\n  grid-template-areas:\n    \"yearOwls yearVisitors\";\n  grid-area: yearContent;\n  */\n  grid-area: yearContent\n}\n\n.yearOwls { grid-area: yearOwls; }\n\n.yearVisitors { grid-area: yearVisitors; }\n\n.yearSide { grid-area: yearSide; }\n\n\n\n</style>\n\n<script src=\"https://unpkg.com/feather-icons\"></script>\n","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":false,"templateScope":"global","x":1400,"y":220,"wires":[[]]},{"id":"2ab34dd6.8d7632","type":"inject","z":"daeabae8.5efdd","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":200,"wires":[["f2457269.631c"]]},{"id":"f2457269.631c","type":"exec","z":"daeabae8.5efdd","command":"free -m","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":520,"y":200,"wires":[["c63ebeea.e318e8"],[],[]]},{"id":"c63ebeea.e318e8","type":"debug","z":"daeabae8.5efdd","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":200,"wires":[]},{"id":"c53d722b.e84fb","type":"function","z":"4d72abac.9f6a5c","name":"Get database calls","func":"// today 00:00\nconst zero = new Date();\nzero.setHours(0,0,0,0);\n\n// current reset timer\ncurrentResetTime = flow.get('current-reset-time')\n\n// today 03:00\nconst three = new Date();\nthree.setHours(3,0,0,0);\n\n// Generate intervals\nconst interval = [{start: 0, end: 12}, {start: 12, end: 17}, {start: 17, end: 24}]\n\nconst start = new Date();\nconst end = new Date();\n\nlet intervals = [];\n\nend.setHours(interval[0].end,0,0,0);\nstart.setHours(interval[0].start,0,0,0);\nintervals.push(\"SELECT SUM(direction_in) from counterTable WHERE time > \" + start.getTime() + \" AND time < \" + end.getTime());\n\nend.setHours(interval[1].end,0,0,0);\nstart.setHours(interval[1].start,0,0,0);\nintervals.push(\"SELECT SUM(direction_in) from counterTable WHERE time > \" + start.getTime() + \" AND time < \" + end.getTime());\n\nend.setHours(interval[2].end,0,0,0);\nstart.setHours(interval[2].start,0,0,0);\nintervals.push(\"SELECT SUM(direction_in) from counterTable WHERE time > \" + start.getTime() + \" AND time < \" + end.getTime());\n\n// Week\nconst curr = new Date(); // get current date\nlet first = curr.getDate() - curr.getDay() + 1; // First day is the day of the week - the day of the week\nlet last = first + 6; // last day is the first day + 6\n\nfirst = first - curr.getDate();\nlast = last - curr.getDate();\n\nlet firstday = new Date();\nfirstday.setDate(firstday.getDate()+first)\nfirstday.setHours(0,0,0,0)\nlet lastday = new Date();\nlastday.setDate(lastday.getDate()+last)\nlastday.setHours(24,0,0,0)\n\n// Month\nvar monthDate = new Date(), y = monthDate.getFullYear(), m = monthDate.getMonth();\nvar monthFirstDay = new Date(y, m, 1);\nvar monthLastDay = new Date(y, m + 1, 0);\n\n// Year\nlet year = new Date().getFullYear();\n\nconst thisYear = new Date(year, 0, 1);\nconst nextYear = new Date(year + 1, 0, 1);\n\n\nmsg.payload = {\n    // this year\n    thisYear: new Date().getFullYear(),\n    \n    // First visitor after 03:00\n    firstVisitor: \"SELECT time from counterTable WHERE instr(door, 'skylab') > 0 AND time > \" + three.getTime() + \" LIMIT 1\",\n    \n    // Current visitors today\n    currentVisitors: \"SELECT SUM(direction_in)-SUM(direction_out) from counterTable WHERE instr(door, 'skylab') > 0 AND time > \" + currentResetTime.getTime(),\n    \n    // Visitors today\n    todayVisitors: \"SELECT SUM(direction_in) from counterTable WHERE instr(door, 'skylab') > 0 AND time > \" + zero.getTime(),\n    \n    todayMorning: intervals[0],\n    todayAfternoon: intervals[1],\n    todayNight: intervals[2],\n    \n    weekVisitors: \"SELECT SUM(direction_in) from counterTable WHERE instr(door, 'skylab') > 0 AND time > \" + firstday.getTime() + \" AND time < \" + lastday.getTime(),\n    monthVisitors:\"SELECT SUM(direction_in) from counterTable WHERE instr(door, 'skylab') > 0 AND time > \" + monthFirstDay.getTime() + \" AND time < \" + monthLastDay.getTime(),\n    yearVisitors: \"SELECT SUM(direction_in) from counterTable WHERE instr(door, 'skylab') > 0 AND time > \" + thisYear.getTime() + \" AND time < \" + nextYear.getTime(),\n    // yearNightowls: \"SELECT SUM(direction_in) from counterTable WHERE time > \" + year.getTime() + \" AND time < \" + nextYear.getTime(),\n    \n}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":100,"wires":[["727cbc40.0c441c"]]},{"id":"ab15ad7d.8a474","type":"inject","z":"4d72abac.9f6a5c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":180,"wires":[["c53d722b.e84fb"]]},{"id":"727cbc40.0c441c","type":"split","z":"4d72abac.9f6a5c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":510,"y":140,"wires":[["6700fd73.664004"]]},{"id":"6797ebdd.744e44","type":"change","z":"4d72abac.9f6a5c","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":320,"wires":[["d59b88e5.bbf7c8"]]},{"id":"d59b88e5.bbf7c8","type":"subflow:fd1ac5b9.8d104","z":"4d72abac.9f6a5c","name":"","x":780,"y":360,"wires":[["483462e2.c06f24"]]},{"id":"483462e2.c06f24","type":"join","z":"4d72abac.9f6a5c","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":890,"y":160,"wires":[["de5ae43.1028f98"]]},{"id":"6700fd73.664004","type":"switch","z":"4d72abac.9f6a5c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"istype","v":"number","vt":"number"},{"t":"istype","v":"string","vt":"string"}],"checkall":"true","repair":false,"outputs":2,"x":530,"y":240,"wires":[["483462e2.c06f24"],["6797ebdd.744e44"]]},{"id":"cbe1075f.d819","type":"function","z":"4d72abac.9f6a5c","name":"Parsing","func":"const firstVisitor = (input) => {\n    let output;\n    \n    if (input === 0) {\n        output = \"No early birds yet\"\n        return output\n    }\n    \n    const date = new Date(input);\n    \n    const hours = \"0\" + date.getHours();\n    const minutes = \"0\" + date.getMinutes();\n    \n    output = hours.substr(-2) + \":\" + minutes.substr(-2);\n    return output;\n}\n\nconst currentVisitors = (input) => {\n    if (input < 0) {return 0}\n    return input\n}\n\n// removes all nulls and flattens\nconst removeNull = (input) => {\n    if (input === null) {return 0}\n    if (Array.isArray(input)) {\n        \n        // flattening\n        let output = input[0][Object.keys(input[0])[0]];\n        if (output === null) {return 0}\n        \n        return output;\n    }\n    return input\n}\n\n// Remove all nulls\nObject.keys(msg.payload).forEach(key => {\n    msg.payload[key] = removeNull(msg.payload[key])\n});\n\n// Format first visitor\nmsg.payload.firstVisitor = firstVisitor(msg.payload.firstVisitor);\nmsg.payload.currentVisitors = currentVisitors(msg.payload.currentVisitors);\n\nreturn msg;","outputs":1,"noerr":0,"x":1240,"y":160,"wires":[["18d0309e.798dcf"]]},{"id":"18d0309e.798dcf","type":"ui_template","z":"4d72abac.9f6a5c","group":"7ad48c00.72c1e4","name":"","order":7,"width":"0","height":"0","format":"<div id=\"counterContent\" >\n    \n    <h1>{{msg.payload.thisYear}} in numbers</h1>\n    \n    <div class=\"grid-container\">\n      <div class=\"counter-item todaySep\"></div>\n      <div class=\"counter-item todayContent\">\n        <div class=\"counter-item firstVisitor\">\n            <table style=width:100%>\n                <tr>\n                    <td><i data-feather=\"coffee\"></i></td>\n                </tr>\n                <tr>\n                    <td><h2>{{msg.payload.firstVisitor}}</h2></td>\n                </tr>\n                <tr>\n                    <td><h3>First visitor</h3></td>\n                </tr>\n            </table>\n        </div>\n        <div class=\"counter-item currentVisitor\">\n            <table style=width:100%>\n                <tr>\n                    <td><i data-feather=\"map-pin\"></i></td>\n                </tr>\n                <tr>\n                    <td><h2>{{msg.payload.currentVisitors}}</h2></td>\n                </tr>\n                <tr>\n                    <td><h3>Current visitors</h3></td>\n                </tr>\n            </table>\n        </div>\n        <div class=\"counter-item intervals\">\n            <table style=\"width:100%\">\n              <tr>\n                <td>\n                    <i class=\"interval-icon\" data-feather=\"sunrise\"></i>\n                    <span class=\"interval-time\"><br/>06-12</span>\n                </td>\n                <td style=\"padding-left: 20px;\">\n                    <span class=\"interval-count\">{{msg.payload.todayMorning}} </span> <span class=\"interval-visitors\"> <br /> Visitors</span>\n                </td>\n              </tr>\n              <tr>\n                <td>\n                    <i class=\"interval-icon\" data-feather=\"sun\"></i>\n                    <span class=\"interval-time\"><br/>12-17</span>\n                </td>\n                <td style=\"padding-left: 20px;\">\n                    <span class=\"interval-count\">{{msg.payload.todayAfternoon}} </span> <span class=\"interval-visitors\"> <br /> Visitors</span>\n                </td>\n              </tr>\n              <tr>\n                <td>\n                    <i class=\"interval-icon\" data-feather=\"moon\"></i>\n                    <span class=\"interval-time\"><br/>17-06</span>\n                </td>\n                <td style=\"padding-left: 20px;\">\n                    <span class=\"interval-count\" >{{msg.payload.todayNight}} </span> <span class=\"interval-visitors\"> <br /> Visitors</span>\n                </td>\n              </tr>\n            </table>\n        </div>\n        <div class=\"counter-item todayVisitors\">\n            <h2 style=\"font-size: 100px!important\">{{msg.payload.todayVisitors}}</h2>\n            <h3>Today visitors</h3>\n        </div>\n      </div>\n      <div class=\"counter-item todaySide sideLines\">Today</div>\n      <div class=\"counter-item weekSep border-top-solid\"></div>\n      <div class=\"counter-item weekContent border-top\"><h2>{{msg.payload.weekVisitors}}</h2><h3>Visitors this week</h3></div>\n      <div class=\"counter-item weekSide sideLines\">This week</div>\n      <div class=\"counter-item monthSep border-top-solid\"></div>\n      <div class=\"counter-item monthContent border-top\"><h2>{{msg.payload.monthVisitors}}</h2><h3>Visitors this month</h3></div>\n      <div class=\"counter-item monthSide sideLines\">This Month</div>\n      <div class=\"counter-item yearSep border-top-solid\"></div>\n      <div class=\"counter-item yearContent border-top\"><h2>{{msg.payload.yearVisitors}}</h2><h3>Visitors this year</h3></div>\n      <div class=\"counter-item sideLines yearSide\">This Year</div>\n    </div>\n</div>\n\n\n\n<script>feather.replace() </script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":1380,"y":160,"wires":[[]]},{"id":"8295b22f.4d768","type":"debug","z":"4d72abac.9f6a5c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":500,"wires":[]},{"id":"2228d810.c4dee","type":"inject","z":"4d72abac.9f6a5c","name":"","topic":"update new day","payload":"","payloadType":"date","repeat":"","crontab":"00 03 * * *","once":false,"onceDelay":0.1,"x":200,"y":500,"wires":[["d97501ad.426738"]]},{"id":"d97501ad.426738","type":"function","z":"4d72abac.9f6a5c","name":"Reset current-reset-time","func":"let now = new Date();\n\nflow.set('current-reset-time', now)\n\nmsg.payload = flow.get('current-reset-time')\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":500,"wires":[["8295b22f.4d768"]]},{"id":"de5ae43.1028f98","type":"function","z":"4d72abac.9f6a5c","name":"Update current-reset-time","func":"now = new Date();\n\nif (msg.payload.firstVisitor.length < 1) {\n    msg.payload.firstVisitor[0] = {firstVisitor: 0};\n}\n\nif (msg.payload.currentVisitors[0][\"SUM(direction_in)-SUM(direction_out)\"] < 0) {\n    flow.set('current-reset-time', now);\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":220,"wires":[["cbe1075f.d819"]]},{"id":"4d9723cb.6673cc","type":"switch","z":"64bf31f7.39303","name":"","property":"payload.door","propertyType":"msg","rules":[{"t":"cont","v":"skylab","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":830,"y":200,"wires":[["6b54cc1.0a23c34"]]},{"id":"db9442fc.267bd","type":"inject","z":"4d72abac.9f6a5c","name":"","topic":"","payload":"current-reset-time","payloadType":"flow","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":420,"y":560,"wires":[["8295b22f.4d768"]]},{"id":"4f3851cb.9c8de","type":"debug","z":"64bf31f7.39303","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":850,"y":280,"wires":[]},{"id":"66d7d696.2b713","type":"debug","z":"8aef53de.c9aa78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1080,"y":160,"wires":[]},{"id":"8ffad7c2.2156e8","type":"http in","z":"5d4f9edd.b92f48","name":"","url":"/heartbeat","method":"post","upload":false,"swaggerDoc":"","x":320,"y":120,"wires":[["e1942ce7.f545e","57e51ad.40a8364"]]},{"id":"e1942ce7.f545e","type":"http response","z":"5d4f9edd.b92f48","name":"","statusCode":"","headers":{},"x":630,"y":120,"wires":[]},{"id":"57e51ad.40a8364","type":"function","z":"5d4f9edd.b92f48","name":"parse heartbeat","func":"const time = new Date().getTime()\n\nlet heartbeat = {};\n\nif (global.get('heartbeat')) {\n    heartbeat = global.get('heartbeat')\n}\n\nheartbeat[msg.payload] = time;\n\nglobal.set('heartbeat', heartbeat)\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":160,"wires":[[]]},{"id":"ddedf532.db4608","type":"http in","z":"5d4f9edd.b92f48","name":"","url":"/debug","method":"get","upload":false,"swaggerDoc":"","x":136,"y":441,"wires":[["82b1fdee.4cf358"]]},{"id":"714d5f9e.fbd2c","type":"http response","z":"5d4f9edd.b92f48","name":"","statusCode":"","headers":{},"x":1090,"y":440,"wires":[]},{"id":"21d5eb1f.380fc4","type":"template","z":"5d4f9edd.b92f48","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<h3>Debugger</h3>\n\n<ul>\n  {{#payload.debugLog}}\n  <li>{{.}}</li>\n  {{/payload.debugLog}}\n</ul>\n\n<h3>Heartbeat</h3>\n<ul>\n  {{#payload.heartbeat}}\n  <li>{{.}}</li>\n  {{/payload.heartbeat}}\n</ul>\n\n<h3>Last message</h3>\n<ul>\n  {{#payload.lastMessage}}\n  <li>{{.}}</li>\n  {{/payload.lastMessage}}\n</ul>\n\n<h3>Errors</h3>\n<ul>\n  {{#payload.errorLog}}\n  <li>{{.}}</li>\n  {{/payload.errorLog}}\n</ul>\n\n\n","output":"str","x":940,"y":440,"wires":[["714d5f9e.fbd2c"]]},{"id":"505d7e5c.fe0b5","type":"http in","z":"5d4f9edd.b92f48","name":"","url":"/error","method":"post","upload":false,"swaggerDoc":"","x":330,"y":220,"wires":[["930df83f.c762d8","98986d31.5f449"]]},{"id":"878c68d7.e7aa08","type":"http in","z":"1e694d7d.101bf3","name":"","url":"/itu","method":"get","upload":false,"swaggerDoc":"","x":150,"y":240,"wires":[["9ba1487.3d5f338"]]},{"id":"6a260a21.2d871c","type":"http response","z":"1e694d7d.101bf3","name":"","statusCode":"","headers":{},"x":1130,"y":420,"wires":[]},{"id":"930df83f.c762d8","type":"http response","z":"5d4f9edd.b92f48","name":"","statusCode":"","headers":{},"x":630,"y":220,"wires":[]},{"id":"98986d31.5f449","type":"function","z":"5d4f9edd.b92f48","name":"parse error","func":"let errorLog = {};\n\nif (global.get('errorLog')) {\n    errorLog = global.get('errorLog')\n}\n\nconst time = new Date().getTime();\n\nconst error = {\n    time: time,\n    door: msg.payload.channel_name,\n    event: msg.payload.event_name\n}\n\n// only if disconnect\nif (error.event == 'Camera disconnected') {errorLog[error.door] = error}\n\nglobal.set('errorLog', errorLog)\n\nmsg.payload = error;\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":260,"wires":[[]]},{"id":"9ba1487.3d5f338","type":"function","z":"1e694d7d.101bf3","name":"query","func":"// today 00:00\nconst zero = new Date();\nzero.setHours(0,0,0,0);\n\n// Month\nvar monthDate = new Date(), y = monthDate.getFullYear(), m = monthDate.getMonth();\nvar monthFirstDay = new Date(y, m, 1);\nvar monthLastDay = new Date(y, m + 1, 0);\n\nmsg.payload = {\n    todayVisitors: \"SELECT SUM(direction_in) from counterTable WHERE instr(door, 'itu') > 0 AND time > \" + zero.getTime(),\n    monthVisitors:\"SELECT SUM(direction_in) from counterTable WHERE instr(door, 'itu') > 0 AND time > \" + monthFirstDay.getTime() + \" AND time < \" + monthLastDay.getTime(),\n    totalVisitors: \"SELECT SUM(direction_in) from counterTable WHERE instr(door, 'itu') > 0\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":160,"wires":[["1d9c984a.391fb8"]]},{"id":"450031a2.c32038","type":"inject","z":"1e694d7d.101bf3","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":160,"wires":[["9ba1487.3d5f338"]]},{"id":"1d9c984a.391fb8","type":"split","z":"1e694d7d.101bf3","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":430,"y":160,"wires":[["94a1ad2.31e635"]]},{"id":"94a1ad2.31e635","type":"change","z":"1e694d7d.101bf3","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":590,"y":160,"wires":[["b451613b.03cca8"]]},{"id":"b451613b.03cca8","type":"subflow:fd1ac5b9.8d104","z":"1e694d7d.101bf3","name":"","x":760,"y":160,"wires":[["e53ad1c0.540b28"]]},{"id":"e53ad1c0.540b28","type":"join","z":"1e694d7d.101bf3","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":950,"y":160,"wires":[["43f3216a.69a3f"]]},{"id":"110eb553.8e2e5b","type":"template","z":"1e694d7d.101bf3","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<h3>Novonordisk ITU door counter</h3>\n\n<table style=\"width:400px; text-align: left;\">\n  <tr>\n    <th>Time</th>\n    <th>Count</th>\n  </tr>\n  <tr>\n    <td>Today</td>\n    <td>{{payload.today}}</td>\n  </tr>\n  <tr>\n    <td>This month</td>\n    <td>{{payload.month}}</td>\n  </tr>\n    <tr>\n    <td>Total</td>\n    <td>{{payload.total}}</td>\n  </tr>\n</table> \n\n<button type=\"button\"><a href=\"itu/download\">List all</a></button>","output":"str","x":1080,"y":300,"wires":[["6a260a21.2d871c"]]},{"id":"43f3216a.69a3f","type":"function","z":"1e694d7d.101bf3","name":"Parse","func":"msg.payload = {\n    today: msg.payload.todayVisitors[0][\"SUM(direction_in)\"],\n    month: msg.payload.monthVisitors[0][\"SUM(direction_in)\"],\n    total: msg.payload.totalVisitors[0][\"SUM(direction_in)\"]\n}\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":240,"wires":[["110eb553.8e2e5b"]]},{"id":"82b1fdee.4cf358","type":"function","z":"5d4f9edd.b92f48","name":"query","func":"const heartbeat = global.get('sensorList') || [] \n\nmsg.payload = [];\n\nfor (const [key, value] of Object.entries(heartbeat)) {\n    msg.payload.push(\"SELECT * from counterTable WHERE instr(door, \" + key + \") ORDER BY time DESC LIMIT 1\")\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":440,"wires":[["57a4c121.d3eb3"]]},{"id":"1f79d596.d25f42","type":"split","z":"5d4f9edd.b92f48","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":250,"y":520,"wires":[["3823687e.029268"]]},{"id":"3823687e.029268","type":"change","z":"5d4f9edd.b92f48","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":520,"wires":[["dbe6ad37.f2702"]]},{"id":"dbe6ad37.f2702","type":"subflow:fd1ac5b9.8d104","z":"5d4f9edd.b92f48","name":"","x":600,"y":520,"wires":[["ad2e191c.c99ad"]]},{"id":"ad2e191c.c99ad","type":"join","z":"5d4f9edd.b92f48","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":750,"y":520,"wires":[["83842364.a959c8"]]},{"id":"83842364.a959c8","type":"function","z":"5d4f9edd.b92f48","name":"parse and get stuff","func":"const debugLog = global.get('debugLog')\nconst heartbeat = global.get('heartbeat')\nconst errorLog = global.get('errorLog')\n\nlet debugOut = [];\nlet heartbeatOut = [];\nlet errorOut = [];\nlet lastMessage = [];\n\n// debugger\nfor (const row of debugLog) {\n    debugOut.push(row.time + \" \" + row.direction + \" \" + row.door);\n}\n\n// heartbeater\nfor (const [key, value] of Object.entries(heartbeat)) {\n    // parse time\n    const date = new Date(value);\n    let time = date.getFullYear();\n    time = time + \"/\" + date.getMonth();\n    time = time + \"/\" + date.getDate();\n    const hours = \"0\" + date.getHours();\n    const minutes = \"0\" + date.getMinutes();\n    time = time + \" \" + hours.substr(-2) + \":\" + minutes.substr(-2);\n\n    heartbeatOut.push(key + \": \" + time);\n}\n\n// Errors\nfor (const [key, value] of Object.entries(errorLog)) {\n    // parse time\n    const date = new Date(value.time);\n    let time = date.getFullYear();\n    time = time + \"/\" + date.getMonth();\n    time = time + \"/\" + date.getDate();\n    const hours = \"0\" + date.getHours();\n    const minutes = \"0\" + date.getMinutes();\n    time = time + \" \" + hours.substr(-2) + \":\" + minutes.substr(-2);\n\n    errorOut.push(key + \": \" + time + \" \" + value.event);\n}\n\n// Last message\nfor (const row of msg.payload) {\n    const date = new Date(row[0].time);\n    let time = date.getFullYear();\n    time = time + \"/\" + date.getMonth();\n    time = time + \"/\" + date.getDate();\n    const hours = \"0\" + date.getHours();\n    const minutes = \"0\" + date.getMinutes();\n    time = time + \" \" + hours.substr(-2) + \":\" + minutes.substr(-2);\n    \n    lastMessage.push(row[0].door + \": \" + time);\n}\n\nmsg.payload = {\n    debugLog: debugOut,\n    heartbeat: heartbeatOut,\n    errorLog: errorOut,\n    lastMessage: lastMessage\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":440,"wires":[["21d5eb1f.380fc4"]]},{"id":"134989a3.1c0bb6","type":"http in","z":"1e694d7d.101bf3","name":"","url":"/itu/download","method":"get","upload":false,"swaggerDoc":"","x":190,"y":660,"wires":[["4d701be5.5568cc"]]},{"id":"6d423223.457524","type":"http response","z":"1e694d7d.101bf3","name":"","statusCode":"","headers":{},"x":1070,"y":660,"wires":[]},{"id":"4d701be5.5568cc","type":"function","z":"1e694d7d.101bf3","name":"query","func":"msg.topic = \"SELECT * from counterTable WHERE instr(door, 'itu') > 0\"\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":660,"wires":[["ee5a0503.df128"]]},{"id":"ee5a0503.df128","type":"subflow:fd1ac5b9.8d104","z":"1e694d7d.101bf3","name":"","x":600,"y":660,"wires":[["3ca7fce0.118bec"]]},{"id":"3ca7fce0.118bec","type":"template","z":"1e694d7d.101bf3","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<table style=\"text-align: center\">\n    <tr>\n        <th>Time</th>\n        <th>Direction_in</th>\n        <th>Direction_out</th>\n    </tr>\n    {{#payload}}\n    <tr>\n        <td>{{time}}</td>\n        <td>{{direction_in}}</td>\n        <td>{{direction_out}}</td>\n    </tr>\n    {{/payload}}\n</table>","output":"str","x":840,"y":660,"wires":[["6d423223.457524","59825579.c8c56c"]]},{"id":"59825579.c8c56c","type":"debug","z":"1e694d7d.101bf3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1060,"y":580,"wires":[]},{"id":"cbe3753.5288908","type":"link in","z":"5d4f9edd.b92f48","name":"","links":["4ff2ea36.bc9d94"],"x":255,"y":660,"wires":[["c3404dfd.7bb598"]]},{"id":"3e23772f.fae348","type":"function","z":"8aef53de.c9aa78","name":"JSON --> SQL","func":"values = Object.values(msg.payload);\nkeys = Object.keys(msg.payload);\n\nmsg.topic = \"INSERT INTO counterTable(\" + keys + \") VALUES(\" + values + \")\"\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["7c0f5ef9.7c67c","4ff2ea36.bc9d94"]]},{"id":"18940b42.68d475","type":"link in","z":"8aef53de.c9aa78","name":"","links":["2970dd42.da8692"],"x":175,"y":100,"wires":[["3e23772f.fae348"]]},{"id":"7c0f5ef9.7c67c","type":"subflow:fd1ac5b9.8d104","z":"8aef53de.c9aa78","name":"","x":840,"y":100,"wires":[[]]},{"id":"4ff2ea36.bc9d94","type":"link out","z":"8aef53de.c9aa78","name":"","links":["cbe3753.5288908"],"x":780,"y":20,"wires":[]},{"id":"5099e27c.a179bc","type":"function","z":"8aef53de.c9aa78","name":"counterTable content","func":"msg.topic = \"SELECT * FROM counterTable ORDER BY time DESC LIMIT 100\"\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":360,"wires":[["7c0f5ef9.7c67c"]]},{"id":"30ec04d2.b53634","type":"inject","z":"8aef53de.c9aa78","name":"counterTable content","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":270,"y":360,"wires":[["5099e27c.a179bc"]]},{"id":"c3404dfd.7bb598","type":"delay","z":"5d4f9edd.b92f48","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":380,"y":660,"wires":[["ea79de80.1fde4"]]},{"id":"ea79de80.1fde4","type":"function","z":"5d4f9edd.b92f48","name":"Debug logger","func":"let debugLog = [];\nlet sensorList = {};\n\nif (global.get('debugLog')) {\n    debugLog = global.get('debugLog')\n}\n\nif (global.get('sensorList')) {\n    sensorList = global.get('sensorList')\n}\n\n// parse time\nconst date = new Date(msg.payload.time);\nconst hours = \"0\" + date.getHours();\nconst minutes = \"0\" + date.getMinutes();\nmsg.payload.time = hours.substr(-2) + \":\" + minutes.substr(-2);\n\n// parse direction\nif (msg.payload.direction_in) {msg.payload.direction = 'In'}\nif (msg.payload.direction_out) {msg.payload.direction = 'Out'}\n\n// push debug\ndebugLog.push(msg.payload);\nif (debugLog.length > 5) {debugLog.shift()}\nglobal.set('debugLog', debugLog)\n\n// push sensorList\nsensorList[msg.payload.door] = msg.payload.time;\nglobal.set('sensorList', sensorList)\n\nmsg.payload = debugLog;\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":660,"wires":[[]]},{"id":"57a4c121.d3eb3","type":"switch","z":"5d4f9edd.b92f48","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":450,"y":440,"wires":[["1f79d596.d25f42"],["83842364.a959c8"]]},{"id":"bd9cc707.c90ba","type":"debug","z":"5d4f9edd.b92f48","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":840,"y":680,"wires":[]},{"id":"725398a7.59c24","type":"http in","z":"22a24c0b.79fce4","name":"","url":"/skylab","method":"get","upload":false,"swaggerDoc":"","x":110,"y":100,"wires":[["dd039b.59df8c68"]]},{"id":"a340e583.41fbf","type":"http response","z":"22a24c0b.79fce4","name":"","statusCode":"","headers":{},"x":1290,"y":520,"wires":[]},{"id":"dd039b.59df8c68","type":"function","z":"22a24c0b.79fce4","name":"query","func":"const sensorList = global.get('sensorList') || [];\nconst heartbeat = global.get('heartbeat') || [];\nconst errorLog = global.get('errorLog') || [];\n\nconst skylabSensors = {};\nfor (const [key, value] of Object.entries(sensorList)) {\n    const sensor = key.substring(1, key.length-1);\n    \n    // If empty errorLog\n    if (!errorLog[sensor]) {\n        errorLog[sensor] = {time: Date.now()}\n    }\n    \n    if (sensor.includes('skylab')) {skylabSensors[sensor] = {\n        internet: heartbeat[sensor.split(';')[0]+';'+sensor.split(';')[1]],\n        cam: errorLog[sensor].time,\n        lastMsg: \"SELECT * from counterTable WHERE instr(door, \" + key + \") ORDER BY time DESC LIMIT 1\"\n    }}\n}\n\n\nmsg.payload = skylabSensors;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":100,"wires":[["9d2863e.43ce8a"]]},{"id":"9d2863e.43ce8a","type":"split","z":"22a24c0b.79fce4","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":450,"y":160,"wires":[["5d4ed23b.cf9be4"]]},{"id":"96229f97.409d7","type":"join","z":"22a24c0b.79fce4","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":970,"y":440,"wires":[["c8adfed2.ba391","81b23b86.36592"]]},{"id":"39636b96.068884","type":"join","z":"22a24c0b.79fce4","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":970,"y":380,"wires":[["96229f97.409d7"]]},{"id":"5d4ed23b.cf9be4","type":"split","z":"22a24c0b.79fce4","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":510,"y":220,"wires":[["1ad0566b.fa6b62"]]},{"id":"1ad0566b.fa6b62","type":"switch","z":"22a24c0b.79fce4","name":"","property":"payload","propertyType":"msg","rules":[{"t":"istype","v":"string","vt":"string"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":570,"y":260,"wires":[["ddfcaee2.c8d458"],["5ded2a76.74641c"]]},{"id":"ddfcaee2.c8d458","type":"change","z":"22a24c0b.79fce4","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":240,"wires":[["e286f993.cadcb"]]},{"id":"e286f993.cadcb","type":"subflow:fd1ac5b9.8d104","z":"22a24c0b.79fce4","name":"","x":900,"y":240,"wires":[["a26a1a1c.2fc51"]]},{"id":"c8adfed2.ba391","type":"debug","z":"22a24c0b.79fce4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1190,"y":380,"wires":[]},{"id":"a26a1a1c.2fc51","type":"change","z":"22a24c0b.79fce4","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload[0].time","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":240,"wires":[["5ded2a76.74641c"]]},{"id":"5ded2a76.74641c","type":"function","z":"22a24c0b.79fce4","name":"To relative time","func":"msg.payload = Date.now() - msg.payload\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":380,"wires":[["39636b96.068884"]]},{"id":"81b23b86.36592","type":"function","z":"22a24c0b.79fce4","name":"template","func":"function numParse(x) {\n  return Number.parseFloat(x).toFixed(1);\n}\n\nlet sensorRows = '';\nfor (const [key, value] of Object.entries(msg.payload)) {\n    sensorRows = sensorRows + '<tr><td>' + key + '</td>'\n    \n    // Internet\n    if (value.internet < 8.64e7) { // less than a day\n        sensorRows = sensorRows + '<td class = \"good\"> Yes </td>'\n    } else {\n        sensorRows = sensorRows + '<td class = \"bad\"> No </td>'\n    }\n    \n    // Camera\n    //if (value.cam < 8.64e7) { // less than a day\n    //    sensorRows = sensorRows + '<td class = \"good\"> Good </td>'\n    //} else {\n    //   sensorRows = sensorRows + '<td class = \"bad\"> Bad </td>'\n    //} \n    \n    // Last message\n    if (value.lastMsg < 8.64e7) { // less than a day\n        sensorRows = sensorRows + '<td class = \"good\">' + numParse(value.lastMsg/1000/60) + ' minutes</td>'\n    } else {\n        sensorRows = sensorRows + '<td class = \"bad\">' + numParse(value.lastMsg/1000/60) + ' minutes</td>'\n    } \n}\n\n\n\nconst html = `\n<div>\n    <h3>Visitor Counter System Status</h3>\n    <table>\n        <tr>\n            <th>Camera</th>\n            <th>Internet Connection</th>\n            <th>Since last message</th>\n        </tr>\n        ` + sensorRows + `\n    </table>\n    \n    <p>Contact Sofus: <br/>Telephone: +45 28 90 08 48 <br/>Mail: sofus@addington.dk</p>\n</div>\n`;\n\nconst css = `\n<style>\nbody {\n  font-family: Arial, Helvetica, sans-serif;\n}\n\ntable {\n    border-collapse: collapse;\n}\n\ntd, th {\n  border: 1px solid #ddd;\n  padding: 8px;\n}\n\ntr:nth-child(even){background-color: #f2f2f2;}\n\ntr:hover {background-color: #ddd;}\n\nth {\n  padding-top: 12px;\n  padding-bottom: 12px;\n  text-align: left;\n  background-color: #04AA6D;\n  color: white;\n}\n\n.good {\n    background-color: green;\n    color: white;\n    text-align: center;\n}\n\n.bad {\n    background-color: red;\n    color: white;\n    text-align: center;\n}\n</style>\n`\n\nmsg.payload = css + html;\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":520,"wires":[["a340e583.41fbf"]]},{"id":"d828369.9c5dec8","type":"http in","z":"22a24c0b.79fce4","name":"","url":"/status","method":"get","upload":false,"swaggerDoc":"","x":110,"y":220,"wires":[["2e3cbabc.75e5be"]]},{"id":"2e3cbabc.75e5be","type":"function","z":"22a24c0b.79fce4","name":"query","func":"const sensorList = global.get('sensorList') || [];\nconst heartbeat = global.get('heartbeat') || [];\nconst errorLog = global.get('errorLog') || [];\n\nconst skylabSensors = {};\nfor (const [key, value] of Object.entries(sensorList)) {\n    const sensor = key.substring(1, key.length-1);\n    \n    // If empty errorLog\n    if (!errorLog[sensor]) {\n        errorLog[sensor] = {time: Date.now()}\n    }\n    \n    skylabSensors[sensor] = {\n        internet: heartbeat[sensor.split(';')[0]+';'+sensor.split(';')[1]],\n        cam: errorLog[sensor].time,\n        lastMsg: \"SELECT * from counterTable WHERE instr(door, \" + key + \") ORDER BY time DESC LIMIT 1\"\n    }\n}\n\n\nmsg.payload = skylabSensors;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":220,"wires":[["9d2863e.43ce8a"]]},{"id":"897f47d3.049298","type":"telegram sender","z":"22a24c0b.79fce4","name":"","bot":"81e28f95.636ad8","haserroroutput":false,"outputs":1,"x":485,"y":680,"wires":[["ab06b058.898ad8"]],"l":false},{"id":"13da6fad.d6ae78","type":"inject","z":"22a24c0b.79fce4","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":680,"wires":[["a2891e3a.f21ad8"]]},{"id":"ab06b058.898ad8","type":"debug","z":"22a24c0b.79fce4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":660,"y":640,"wires":[]},{"id":"a2891e3a.f21ad8","type":"function","z":"22a24c0b.79fce4","name":"","func":"msg.payload = {\n    type: 'text',\n    content: 'hej',\n    chatID: '-406643591'\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":680,"wires":[["897f47d3.049298"]]}]